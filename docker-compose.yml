# ─── ClipForge — Docker Compose ──────────────────────────────────
# Usage:
#   docker compose up --build        (start all services)
#   docker compose up --build -d     (detached / background)
#   docker compose down              (stop)
#   docker compose logs -f worker    (follow worker logs)

version: "3.9"

services:
  # ── Redis — message broker + result backend ──────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  # ── Web — FastAPI server (serves UI + REST API) ──────────────
  web:
    build: .
    restart: unless-stopped
    ports:
      - "${PORT:-8000}:8000"
    env_file: .env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CLIPFORGE_UPLOAD_DIR=/data/uploads
      - CLIPFORGE_OUTPUT_DIR=/data/outputs
      - CLIPFORGE_WORK_DIR=/data/tmp_work
    volumes:
      - clipforge-data:/data
    depends_on:
      - redis
    command: >
      uvicorn web.app:app
      --host 0.0.0.0
      --port 8000
      --workers 2
      --timeout-keep-alive 120

  # ── Worker — Celery worker (runs the video pipeline) ─────────
  worker:
    build: .
    restart: unless-stopped
    env_file: .env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CLIPFORGE_UPLOAD_DIR=/data/uploads
      - CLIPFORGE_OUTPUT_DIR=/data/outputs
      - CLIPFORGE_WORK_DIR=/data/tmp_work
    volumes:
      - clipforge-data:/data
    depends_on:
      - redis
    command: >
      celery -A web.tasks worker
      --loglevel=info
      --concurrency=1
      --max-tasks-per-child=5
    deploy:
      resources:
        limits:
          memory: 4G

volumes:
  redis-data:
  clipforge-data:
